# Техническа Документация

---

## Съдържание

1. [Преглед на хардуера](#преглед-на-хардуера)
2. [LiDAR сензор: MB-1R2T V1.5.8](#lidar-сензор-mb-1r2t-v158)
3. [USB-към-сериен конвертор: FT232RL](#usb-към-сериен-конвертор-ft232rl)
4. [Физическа връзка и окабеляване](#физическа-връзка-и-окабеляване)
5. [Протокол за серийна комуникация](#протокол-за-серийна-комуникация)
6. [Структура на пакетите с данни](#структура-на-пакетите-с-данни)
7. [Анализ на протокола на ниво байт](#анализ-на-протокола-на-ниво-байт)
8. [Принципи на измерване на разстояние](#принципи-на-измерване-на-разстояние)
9. [Качество на сигнала и филтриране](#качество-на-сигнала-и-филтриране)
10. [Времеви характеристики и скорост на данните](#времеви-характеристики-и-скорост-на-данните)
11. [Софтуерна имплементация](#софтуерна-имплементация)
12. [Отстраняване на проблеми](#отстраняване-на-проблеми)

---

## Преглед на хардуера

Този проект свързва **китайски MB-1R2T V1.5.8** 2D LiDAR скенер с компютър чрез **FTDI FT232RL** USB-към-сериен конвертор. Системата позволява сканиране на околната среда в реално време на 360° с измерване на разстояние до 12 метра.

### Блокова схема на системата

```
┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│                 │      │                 │      │                 │
│   MB-1R2T       │ TTL  │    FT232RL      │ USB  │    Компютър     │
│   LiDAR         │─────▶│    Конвертор    │─────▶│    (Хост)       │
│   Сензор        │ UART │                 │      │                 │
│                 │      │                 │      │                 │
└─────────────────┘      └─────────────────┘      └─────────────────┘
     5V DC                    3.3V/5V               USB захранване
```

---

## LiDAR сензор: MB-1R2T V1.5.8

### Какво е LiDAR?

**LiDAR** (Light Detection and Ranging - Откриване и измерване чрез светлина) е технология за дистанционно отчитане, която използва лазерна светлина за измерване на разстояния. MB-1R2T е **Time-of-Flight (ToF)** базиран 2D LiDAR, който излъчва инфрачервени лазерни импулси и измерва времето, необходимо на светлината да се върне след удар в обект.

### Технически спецификации

| Параметър | Стойност |
|-----------|----------|
| Модел | MB-1R2T V1.5.8 |
| Тип | 2D 360° сканиращ LiDAR |
| Принцип на измерване | Time-of-Flight (ToF) |
| Дължина на вълната на лазера | 785-905nm (близък инфрачервен) |
| Клас на лазера | Клас 1 (безопасен за очите) |
| Обхват | 0.15m - 12m (типичен) |
| Ъглова резолюция | ~0.5° - 1° |
| Честота на сканиране | 5-10 Hz (оборота в секунда) |
| Ъглов обхват | 360° (пълно завъртане) |
| Работно напрежение | 5V DC |
| Консумация на ток | 200-400mA |
| Комуникация | UART TTL (съвместим с 3.3V/5V) |
| Скорост на предаване | 153600 bps |

### Вътрешни компоненти

MB-1R2T съдържа няколко ключови компонента:

#### 1. **Лазерен диод (TX - Предавател)**
- Излъчва кратки импулси инфрачервена светлина (785-905nm дължина на вълната)
- Продължителност на импулса: ~5-10 наносекунди
- Невидим за човешкото око, но откриваем от сензора
- Модулиран на висока честота за отхвърляне на шума

#### 2. **Фотодетектор (RX - Приемник)**  
- Лавинен фотодиод (APD) или PIN фотодиод
- Изключително чувствителен към връщащата се лазерна светлина
- Включва оптичен лентов филтър за отхвърляне на околната светлина
- Преобразува фотони в електрически сигнал

#### 3. **Въртящо се огледало/призма**
- Моторизиран въртящ механизъм (обикновено безчетков DC мотор)
- Отклонява лазерния лъч през 360°
- Енкодер проследява точната ъглова позиция
- Скорост на въртене: 5-10 оборота в секунда

#### 4. **Драйвер на мотора и управляваща верига**
- PID контролер поддържа постоянна скорост на въртене
- Генерира данни за ъглова позиция
- Синхронизира измерванията с въртенето

#### 5. **Блок за обработка на сигнала (MCU)**
- Обикновено микроконтролер от серията ARM Cortex-M
- Извършва ToF изчисления
- Обработва UART комуникацията
- Изпълнява фърмуер за форматиране на пакети

#### 6. **Управление на захранването**
- Стабилизатори на напрежение (5V към 3.3V, 1.8V)
- Верига за управление на мотора
- Верига за управление на лазера с предпазители

### Как работи Time-of-Flight

```
          t₀ (лазерът се активира)
             │
             ▼
    ┌────────────────┐
    │   LiDAR TX     │ ═══════▶ Лазерен импулс
    └────────────────┘
                              │
                              │ пътува със скоростта на светлината
                              │ c = 299,792,458 m/s
                              ▼
                        ┌──────────┐
                        │  Обект   │
                        └──────────┘
                              │
                              │ отразява се обратно
                              ▼
    ┌────────────────┐
    │   LiDAR RX     │ ◀═══════ Върнат импулс
    └────────────────┘
             │
             ▼
          t₁ (импулсът е открит)

    Разстояние = (c × Δt) / 2
    
    Където:
    - c = скорост на светлината (299,792,458 m/s)
    - Δt = t₁ - t₀ (време за двупосочно пътуване)
    - Делим на 2, защото светлината пътува до обекта И обратно
```

**Примерно изчисление:**
- Обект на 3 метра
- Двупосочно разстояние: 6 метра
- Време: 6m ÷ 299,792,458 m/s = 20.01 наносекунди
- Сензорът измерва този невероятно кратък времеви интервал!

---

## USB-към-сериен конвертор: FT232RL

### Какво е FT232RL?

**FT232RL** е USB към сериен UART интерфейсна интегрална схема, произведена от **FTDI (Future Technology Devices International)**. Тя преобразува USB сигнали в TTL-ниво UART сигнали, които LiDAR сензорът разбира.

### Технически спецификации

| Параметър | Стойност |
|-----------|----------|
| Производител | FTDI |
| Интерфейс | USB 2.0 Full Speed |
| USB скорост | 12 Mbps |
| UART скорости на предаване | 300 bps до 3 Mbps |
| Логически нива | 5V или 3.3V (конфигурируеми) |
| FIFO буфери | 128 байта TX, 256 байта RX |
| Работно напрежение | 3.3V до 5.25V |
| Ток (USB захранване) | ~15mA |

### Вътрешна архитектура

```
┌──────────────────────────────────────────────────────────────┐
│                        FT232RL                                │
│                                                               │
│  ┌─────────┐    ┌──────────────┐    ┌─────────────────────┐  │
│  │   USB   │    │   USB        │    │    UART двигател    │  │
│  │ Прием-  │───▶│   Протоколен │───▶│                     │  │
│  │ ник     │    │   двигател   │    │  Генератор на       │  │
│  │         │◀───│              │◀───│  скорост            │  │
│  └─────────┘    └──────────────┘    │  Старт/Стоп битове  │  │
│       │                              │  Форматиране        │  │
│       │              │               └─────────────────────┘  │
│       │         ┌────┴────┐             ┌─────┴─────┐        │
│       │         │  EEPROM │             │   FIFO    │        │
│       │         │  93C46  │             │  Буфери   │        │
│       │         │  Конфиг │             │ TX:128B   │        │
│       │         └─────────┘             │ RX:256B   │        │
│       │                                 └───────────┘        │
│       ▼                                       │               │
│   USB D+/D-                              TXD/RXD              │
│   (към хост)                             (към LiDAR)         │
└──────────────────────────────────────────────────────────────┘
```

### Защо FT232RL?

1. **Поддръжка на драйвери**: Вградени драйвери в macOS, Windows, Linux
2. **Надеждно времене**: Хардуерно генериране на скорост на предаване
3. **Управление на буфери**: Обработва високоскоростни данни без загуба
4. **Индустриален стандарт**: Широко използван, добре документиран

### Процес на USB изброяване

Когато включите FT232RL:

1. **USB откриване** (в рамките на 100ms)
   - Хостът открива свързване на устройството чрез промяна на напрежението на D+/D-
   - Устройството изтегля ≤100mA първоначално

2. **Изброяване** (в рамките на 2 секунди)
   - Хостът изпраща GET_DESCRIPTOR заявки
   - Устройството докладва VID=0x0403, PID=0x6001 (FTDI стандарт)
   - Хостът зарежда FTDI драйвер (вграден в модерните ОС)

3. **Конфигуриране**
   - Драйверът създава виртуален COM порт
   - macOS: `/dev/cu.usbserial-XXXXXX`
   - Windows: `COM3`, `COM4`, и т.н.
   - Linux: `/dev/ttyUSB0`

4. **Готов за комуникация**
   - Приложението отваря серийния порт
   - Задава скорост на предаване (153600 за този LiDAR)
   - Данните текат двупосочно

---

## Физическа връзка и окабеляване

### Свързване на пинове

```
MB-1R2T LiDAR          FT232RL Модул
─────────────          ──────────────
    VCC  ●────────────● VCC (5V)
    GND  ●────────────● GND
    TX   ●────────────● RX
    RX   ●────────────● TX (опционално, не се използва)

Забележка: TX/RX са кръстосани - LiDAR TX се свързва към FT232RL RX
```

### Нива на напрежение

```
TTL UART сигнални нива:

        5V ─┬─────────────────────────────┬─ Логическа ЕДИНИЦА (1)
            │                             │
            │    ████████      ████████   │
            │    █      █      █      █   │
            │    █      █      █      █   │
        0V ─┴────█──────█──────█──────█───┴─ Логическа НУЛА (0)
                 │      │      │      │
                 └──────┘      └──────┘
                 
            Старт    Битове данни   Стоп
            бит     (LSB първи)     бит
```

### Съображения за дължина на кабела

| Дължина на кабела | Качество на сигнала | Препоръка |
|-------------------|---------------------|-----------|
| < 30cm | Отлично | Идеално за прототипиране |
| 30cm - 1m | Добро | Използвайте качествен екраниран кабел |
| 1m - 3m | Влошено | Може да се наложи по-ниска скорост |
| > 3m | Лошо | Използвайте RS-485 или усилвател |

---

## Протокол за серийна комуникация

### UART конфигурация

| Параметър | Стойност | Описание |
|-----------|----------|----------|
| Скорост на предаване | 153600 bps | Битове в секунда |
| Битове данни | 8 | Размер на полезния товар на кадър |
| Стоп битове | 1 | Терминатор на кадър |
| Паритет | Няма | Без бит за проверка на грешки |
| Управление на потока | Няма | Без хардуерно ръкостискане |

### Защо 153600 бода?

Тази необичайна скорост на предаване (не "стандартна" скорост като 115200 или 230400) е избрана поради:

1. **Изисквания за пропускателна способност на данни**:
   - LiDAR произвежда ~400-600 пакета/секунда
   - Всеки пакет: ~120-150 байта средно
   - Необходима честотна лента: ~80,000 байта/секунда минимум
   - 153600 бода ≈ 15,360 байта/секунда теоретичен максимум (с overhead)
   - Реално поддържа ~14,000 байта/секунда ефективна пропускателна способност

2. **Съвместимост с честота на кристала**:
   - LiDAR MCU вероятно използва обичаен кристал (напр. 24.576 MHz)
   - 153600 = 24,576,000 ÷ 160 (чисто деление)

### Структура на UART кадър

Всеки предаден байт следва този модел:

```
     1 бит    8 бита (LSB първи)    1 бит
    ┌─────┬───────────────────────┬──────┐
    │Старт│ D0 D1 D2 D3 D4 D5 D6 D7│ Стоп │
    │  0  │        ДАННИ          │  1   │
    └─────┴───────────────────────┴──────┘
    
Общо: 10 бита на байт (8 данни + 1 старт + 1 стоп)
Ефективна скорост на данни: 153600 ÷ 10 = 15,360 байта/секунда
```

---

## Структура на пакетите с данни

### Пълен формат на пакет

MB-1R2T изпраща данни в структурирани пакети, всеки съдържащ множество измервания на разстояние:

```
┌────────────────────────────────────────────────────────────────────────┐
│                         ПЪЛЕН ПАКЕТ                                    │
├────────┬────────┬────────┬────────┬────────────┬────────────┬─────────┤
│ЗАГЛАВИЕ│ЗАГЛАВИЕ│  ТИП   │  БРОЙ  │НАЧАЛЕН ЪГЪЛ│ КРАЕН ЪГЪЛ │НЕИЗВЕСТ.│
│  0xAA  │  0x55  │  байт  │  байт  │  2 байта   │  2 байта   │ 2 байта │
├────────┴────────┴────────┴────────┴────────────┴────────────┴─────────┤
│                      ДАННИ ОТ ИЗМЕРВАНИЯ                               │
│              (БРОЙ × 3 байта на измерване)                             │
│  ┌─────────┬──────────────────────────────────────┐                   │
│  │Качество │     Разстояние (16-бит LE)           │ × БРОЙ            │
│  │ 1 байт  │     2 байта                          │                   │
│  └─────────┴──────────────────────────────────────┘                   │
└────────────────────────────────────────────────────────────────────────┘

Общ размер на пакета: 9 + (БРОЙ × 3) байта
Типичен пакет: 9 + (40 × 3) = 129 байта
```

### Разбивка байт по байт

| Отместване | Размер | Поле | Описание |
|------------|--------|------|----------|
| 0 | 1 | Заглавие 1 | Винаги `0xAA` (170 десетично) |
| 1 | 1 | Заглавие 2 | Винаги `0x55` (85 десетично) |
| 2 | 1 | Тип | Идентификатор на типа пакет |
| 3 | 1 | Брой | Брой измервания (N) |
| 4-5 | 2 | Начален ъгъл | Ъгъл × 100, Little-Endian |
| 6-7 | 2 | Краен ъгъл | Ъгъл × 100, Little-Endian |
| 8 | 2 | Резервирано | Неизвестни/контролни байтове |
| 9+ | N×3 | Данни | Тройки измервания |

### Заглавни байтове: 0xAA 0x55

Магическите байтове `0xAA 0x55` служат като **синхронизиращ модел**:

```
Двоично представяне:
0xAA = 1010 1010
0x55 = 0101 0101

Комбинирано: 1010 1010 0101 0101

Този редуващ се битов модел е:
1. Лесен за откриване в шумен поток от данни
2. Малко вероятно да се появи случайно в данните за измерване
3. Само-синхронизиращ (помага на приемника да се синхронизира)
```

### Кодиране на ъгъл

Ъглите са кодирани като 16-битови Little-Endian цели числа, представящи **ъгъл × 100** (центиградуси):

```
Пример: Ъгъл = 127.45°

Кодирана стойност = 127.45 × 100 = 12745
В шестнадесетичен: 12745 = 0x31C9

Little-Endian ред на байтове:
Байт 4 (LSB): 0xC9 = 201
Байт 5 (MSB): 0x31 = 49

Сурови байтове: C9 31

Декодиране:
(201 + 49×256) / 100 = (201 + 12544) / 100 = 127.45°
```

### Структура на данните от измерване

Всяко измерване съдържа 3 байта:

```
┌──────────────────────────────────────────────────────────────┐
│                    ИЗМЕРВАНЕ (3 байта)                       │
├────────────────┬─────────────────────────────────────────────┤
│   КАЧЕСТВО     │         РАЗСТОЯНИЕ (Little-Endian)          │
│    Байт 0      │        Байт 1 (LSB)  │  Байт 2 (MSB)        │
├────────────────┼─────────────────────────────────────────────┤
│  Сила на       │       Разстояние в милиметри                │
│  сигнала       │       Обхват: 0 - 65535mm                   │
│  (0-255)       │       (~0 - 65.5 метра)                     │
└────────────────┴─────────────────────────────────────────────┘
```

---

## Анализ на протокола на ниво байт

### Пример за реален пакет

Ето реално заловен пакет с пълен анализ:

```
Суров шестнадесетичен дъмп:
AA 55 00 28 90 6E A0 7A 00 00 47 D0 03 48 D4 03 
4A DA 03 4B E0 03 4C E6 03 4D EC 03 4E F2 03 50 
F8 03 51 FE 03 52 04 04 53 0A 04 55 10 04 56 16 
04 57 1C 04 58 22 04 59 28 04 5B 2E 04 5C 34 04 
...

Парсната структура:
┌─────────────────────────────────────────────────────────────────┐
│ Байтове 0-1:  AA 55       Заглавие (синхр. модел)               │
│ Байт 2:       00          Тип на пакета                         │
│ Байт 3:       28          Брой = 40 измервания                  │
│ Байтове 4-5:  90 6E       Начален ъгъл: 0x6E90 = 28304 → 283.04°│
│ Байтове 6-7:  A0 7A       Краен ъгъл: 0x7AA0 = 31392 → 313.92°  │
│ Байтове 8-9:  00 00       Резервирани байтове                   │
└─────────────────────────────────────────────────────────────────┘

Данни от измервания (първите 5 от 40):
┌─────┬─────────┬─────────────┬──────────────────────────────────┐
│  #  │Качество │ Раз-е (hex) │ Разстояние (декодирано)          │
├─────┼─────────┼─────────────┼──────────────────────────────────┤
│  1  │   0x47  │   D0 03     │ 0x03D0 = 976mm = 0.976m          │
│  2  │   0x48  │   D4 03     │ 0x03D4 = 980mm = 0.980m          │
│  3  │   0x4A  │   DA 03     │ 0x03DA = 986mm = 0.986m          │
│  4  │   0x4B  │   E0 03     │ 0x03E0 = 992mm = 0.992m          │
│  5  │   0x4C  │   E6 03     │ 0x03E6 = 998mm = 0.998m          │
└─────┴─────────┴─────────────┴──────────────────────────────────┘

Изчисление на ъглова стъпка:
Ъглов обхват: 313.92° - 283.04° = 30.88°
Измервания: 40
Стъпка: 30.88° / 39 = 0.792° на измерване
```

### Битово ниво анализ на стойност на разстояние

```
Пример: Разстояние = 986mm = 0x03DA

Двоична разбивка:
0x03 = 0000 0011 (MSB - Най-значим байт)
0xDA = 1101 1010 (LSB - Най-малко значим байт)

Little-Endian съхранение (LSB първи):
Памет: [DA] [03]
        │     │
        │     └── Байт на отместване+2
        └──────── Байт на отместване+1

Реконструкция на 16-битова стойност:
LSB + (MSB × 256)
= 0xDA + (0x03 × 0x100)
= 218 + 768
= 986 mm
```

### Откриване на невалидни отчитания

Определени стойности указват невалидни измервания:

```
НЕВАЛИДНИ ОТЧИТАНИЯ:
────────────────────

1. Разстояние ≥ 60000mm (0xEA60)
   - Указва: Няма върнат сигнал (обектът е твърде далеч или няма отражение)
   - Пример: 65240mm (0xFED8) - типична стойност "няма обект"
   
2. Разстояние = 0
   - Указва: Обектът е твърде близо (под минималния обхват)
   - Минимален обхват обикновено ~150mm

3. Качество ≤ 5
   - Указва: Слаб върнат сигнал, ненадеждно измерване
   - Причини: Прозрачни/тъмни обекти, екстремни ъгли
   
Често срещани невалидни модели:
┌─────────────┬────────────┬──────────────────────────┐
│ Качество    │ Разстояние │ Интерпретация            │
├─────────────┼────────────┼──────────────────────────┤
│ 0x01 (1)    │ 0xFA00     │ Няма открит обект        │
│ 0x00 (0)    │ 0xFFFF     │ Грешка на сензора        │
│ 0x05 (5)    │ 0xEA60     │ Много слабо отражение    │
│ 0x02 (2)    │ 0xF0A0     │ Извън обхват             │
└─────────────┴────────────┴──────────────────────────┘
```

---

## Принципи на измерване на разстояние

### Детайли на Time-of-Flight изчислението

```
Физически константи:
────────────────────
Скорост на светлината (c): 299,792,458 m/s
                           ≈ 0.2998 m/ns (метри на наносекунда)
                           ≈ 0.2998 mm/ps (милиметри на пикосекунда)

Необходима времева резолюция:
─────────────────────────────
За точност от 1mm:
Двупосочно разстояние: 2mm
Време = 2mm ÷ 299,792,458,000 mm/s
      = 6.67 пикосекунди

Сензорът трябва да измерва времеви интервали от ~7 пикосекунди!
Това се постига с помощта на специализирани Time-to-Digital Converters (TDC).
```

### Процес на измерване

```
    Време ─────────────────────────────────────────────────────▶

    ┌───┐
    │TX │ Лазерен импулс изстрелян в t₀
    └─┬─┘
      │
      └──── Фотони пътуват навън ────▶ ●●●●●●●●●●●●●●●●●●●●●●
                                                              │
                                                    ┌─────────┴───┐
                                                    │   Целеви    │
                                                    │   обект     │
                                                    └─────────┬───┘
                                                              │
           ◀──── Фотони се връщат ──── ●●●●●●●●●●●●●●●●●●●●●●──┘
      │
    ┌─┴─┐
    │RX │ Върнат импулс открит в t₁
    └───┘

    Измерване:
    Δt = t₁ - t₀
    Разстояние = (c × Δt) / 2
```

### Източници на грешка

| Източник на грешка | Величина | Смекчаване |
|--------------------|----------|------------|
| Трептене на часовника | ±1-5mm | Висококачествен кристал, осредняване |
| Температурен дрейф | ±2mm/°C | Вътрешна компенсация |
| Отразяемост на целта | ±1-10mm | Филтриране базирано на качество |
| Многопътно отражение | Променливо | Обработка на сигнала |
| Атмосферни условия | <0.1mm/m | Обикновено незначително |

---

## Качество на сигнала и филтриране

### Интерпретация на стойността за качество

Байтът за качество (0-255) представлява съотношението сигнал-шум на връщането:

```
Обхвати на качество:
────────────────────

  0-5:    ████░░░░░░░░░░░░░░░░  Много лошо - Отхвърли
  6-30:   ████████░░░░░░░░░░░░  Лошо - Използвай с внимание
 31-80:   ████████████░░░░░░░░  Задоволително - Приемливо
 81-150:  ████████████████░░░░  Добро - Надеждно
151-200:  ████████████████████  Отлично - Висока увереност
201-255:  ████████████████████  Максимум - Ретрорефлектор или близък обект

Фактори, влияещи на качеството:
┌──────────────────────┬───────────────────────────────────┐
│ Фактор               │ Ефект върху качеството            │
├──────────────────────┼───────────────────────────────────┤
│ Разстояние           │ Намалява с разстояние (1/r²)      │
│ Цвят на повърхност   │ Тъмни повърхности = по-ниско      │
│ Ъгъл на повърхност   │ Плътъшки ъгли = по-ниско качество │
│ Материал             │ Матово > Лъскаво > Прозрачно      │
│ Околна светлина      │ Слънцето намалява качеството      │
│ Ретрорефлектор       │ Много високо качество (>200)      │
└──────────────────────┴───────────────────────────────────┘
```

### Препоръчителна стратегия за филтриране

```python
def is_valid_measurement(quality, distance):
    """
    Филтрира невалидни LiDAR измервания
    
    Връща True ако измерването трябва да се използва
    """
    # Отхвърли много ниско качество (шум)
    if quality <= 5:
        return False
    
    # Отхвърли разстояния "без връщане"
    if distance >= 60000:  # 60+ метра
        return False
    
    # Отхвърли нулево разстояние (твърде близо)
    if distance == 0:
        return False
    
    # Опционално: Отхвърли подозрително високо качество на дълъг обхват
    # (може да е кросток или смущение)
    if distance > 10000 and quality > 200:
        return False  # 10m с макс качество е подозрително
    
    return True
```

---

## Времеви характеристики и скорост на данните

### Анализ на потока от данни

```
Скорост на въртене на LiDAR: ~7 Hz (7 оборота в секунда)
Измервания на оборот: ~500-720 точки (0.5°-1° резолюция)
Измервания в секунда: ~3500-5000 точки

Статистика на пакетите:
───────────────────────
Пакети на оборот: ~12-18
Измервания на пакет: 30-40 (типично)
Пакети в секунда: ~100-150
Байтове на пакет: ~100-130
Общ дебит на данни: ~12,000-18,000 байта/секунда

Използване на серийния порт:
────────────────────────────
Скорост: 153600 bps
Макс пропускателна способност: ~15,360 байта/секунда
Типично използване: ~80-90% от капацитета
```

### Времева диаграма

```
Време (ms)
0    10   20   30   40   50   60   70   80   90   100  110  120  130  140
│    │    │    │    │    │    │    │    │    │    │    │    │    │    │
├────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┤
│                    Един оборот на LiDAR (~143ms при 7Hz)             │
├──────────────────────────────────────────────────────────────────────┤

Пакети по време на оборота:
│▓▓│  │▓▓│  │▓▓│  │▓▓│  │▓▓│  │▓▓│  │▓▓│  │▓▓│  │▓▓│  │▓▓│  │▓▓│  │▓▓│
 P1    P2    P3    P4    P5    P6    P7    P8    P9   P10   P11   P12

Всеки пакет (▓▓):
- Продължителност: ~8-10ms време за предаване
- Съдържа: ~35-40 измервания
- Покрива: ~25-30° от въртенето
```

---

## Софтуерна имплементация

### Четене на данни (Python)

```python
import serial

# Отвори сериен порт
ser = serial.Serial(
    port='/dev/cu.usbserial-A5069RR4',  # macOS
    # port='COM3',                       # Windows
    baudrate=153600,
    bytesize=serial.EIGHTBITS,
    parity=serial.PARITY_NONE,
    stopbits=serial.STOPBITS_ONE,
    timeout=0  # Неблокиращ
)

def parse_packet(buffer):
    """
    Парсва пълен LiDAR пакет от буфера
    Връща списък от (ъгъл, разстояние, качество) кортежи
    """
    points = []
    
    # Провери заглавието
    if buffer[0] != 0xAA or buffer[1] != 0x55:
        return None
    
    # Извлечи информация за пакета
    packet_type = buffer[2]
    num_measurements = buffer[3]
    
    # Декодирай ъгли (16-бит Little-Endian, стойност = градуси × 100)
    start_angle = (buffer[4] | (buffer[5] << 8)) / 100.0
    end_angle = (buffer[6] | (buffer[7] << 8)) / 100.0
    
    # Обработи преминаване през нула (напр. 350° до 10°)
    if end_angle < start_angle:
        end_angle += 360.0
    
    # Изчисли ъглова стъпка
    if num_measurements > 1:
        angle_step = (end_angle - start_angle) / (num_measurements - 1)
    else:
        angle_step = 0
    
    # Парсни всяко измерване
    for i in range(num_measurements):
        offset = 9 + i * 3
        
        quality = buffer[offset]
        distance = buffer[offset + 1] | (buffer[offset + 2] << 8)
        
        # Филтрирай невалидни отчитания
        if distance < 60000 and quality > 5:
            angle = (start_angle + i * angle_step) % 360
            points.append((angle, distance, quality))
    
    return points
```

### Синхронизация на пакети

```python
def find_packet_start(buffer):
    """
    Намира началото на валиден пакет в буфера
    Връща индекс на началото на пакета, или -1 ако не е намерен
    """
    for i in range(len(buffer) - 1):
        if buffer[i] == 0xAA and buffer[i + 1] == 0x55:
            # Провери дали имаме достатъчно байтове да прочетем заглавието
            if i + 9 <= len(buffer):
                num_measurements = buffer[i + 3]
                packet_length = 9 + num_measurements * 3
                
                # Провери дали дължината на пакета е разумна
                if num_measurements <= 100:
                    return i
    
    return -1
```

---

## Отстраняване на проблеми

### Често срещани проблеми

| Проблем | Симптоми | Решение |
|---------|----------|---------|
| Няма данни | Портът се отваря но няма пакети | Провери окабеляването, провери 5V захранване |
| Повредени данни | Деформирани пакети, CRC грешки | Провери скоростта (трябва да е 153600) |
| Портът е заключен | Грешка "Resource busy" | Убий други процеси, включи USB отново |
| Прекъсващо | Работи после спира | Препълване на буфер, обработвай по-бързо |
| Липсващи точки | Празнини в скана | Нормално - някои повърхности не отразяват |

### Диагностични команди

**macOS:**
```bash
# Покажи USB устройства
ls /dev/cu.usb*

# Провери USB информация
system_profiler SPUSBDataType | grep -A10 "Serial"

# Наблюдавай серийни данни (сурови)
cat /dev/cu.usbserial-* | xxd | head -100
```

**Windows:**
```powershell
# Покажи COM портове
Get-WMIObject Win32_SerialPort

# Провери device manager
devmgmt.msc
```

**Linux:**
```bash
# Покажи USB серийни устройства
ls /dev/ttyUSB*

# Провери съобщения на ядрото
dmesg | grep tty

# Наблюдавай серийни данни
cat /dev/ttyUSB0 | xxd | head -100
```

---

## Приложение А: Шестнадесетична справка

```
Често срещани стойности в пакетите:

Заглавие:   AA 55     (Маркер за начало на пакет)
Тип:        00        (Стандартен пакет за измерване)
Брой:       28        (40 измервания в hex)

Примери за ъгъл (Little-Endian):
00 00 → 0.00°
E8 03 → 10.00°     (0x03E8 = 1000 центиградуса)
D0 07 → 20.00°     (0x07D0 = 2000)
10 27 → 100.00°    (0x2710 = 10000)
20 4E → 200.00°    (0x4E20 = 20000)
30 75 → 300.00°    (0x7530 = 30000)

Примери за разстояние (Little-Endian):
E8 03 → 1000mm = 1.0m
D0 07 → 2000mm = 2.0m
10 27 → 10000mm = 10.0m

Невалидни маркери:
60 EA → 60000mm (маркер за извън обхват)
FF FF → 65535mm (няма отражение)
```

---

## Приложение Б: Справки

1. FTDI FT232R Datasheet
2. Принципи на работа на ToF LiDAR
3. Спецификация на UART протокол
4. USB 2.0 спецификация
5. MB-1R2T документация на производителя (китайски)

---

*Документация създадена за проекта за визуализация на MB-1R2T LiDAR + FT232RL*
*Последна актуализация: Февруари 2026*
